{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ video.title }} - VideoTube{% endblock %}

{% block content %}
<div class="watch-page">
    <div class="watch-main">
        <!-- Video Player -->
        <div class="video-player">
            <video controls autoplay>
                <source src="{{ video.video_file.url }}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        </div>

        <!-- Video Info -->
        <div class="video-primary-info">
            <h1 class="video-title-large">{{ video.title }}</h1>
            <div class="video-info-bar">
                <div class="video-stats">
                    <span>{{ video.views }} views</span>
                    <span class="separator">â€¢</span>
                    <span>{{ video.created_at|date:"M d, Y" }}</span>
                </div>
                <div class="video-actions">
                    <button class="action-btn {% if user_like == 'like' %}active{% endif %}" id="likeBtn"
                        data-action="like">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor"
                                d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z" />
                        </svg>
                        <span id="likeCount">{{ like_count }}</span>
                    </button>
                    <button class="action-btn {% if user_like == 'dislike' %}active{% endif %}" id="dislikeBtn"
                        data-action="dislike">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor"
                                d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z" />
                        </svg>
                        <span id="dislikeCount">{{ dislike_count }}</span>
                    </button>
                    <button class="action-btn">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor"
                                d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z" />
                        </svg>
                        Share
                    </button>
                </div>
            </div>
        </div>

        <!-- Channel Info -->
        <div class="video-secondary-info">
            <div class="channel-info">
                <a href="{% url 'channel' video.user.id %}" class="channel-avatar">
                    {{ video.user.username|slice:":1"|upper }}
                </a>
                <div class="channel-details">
                    <a href="{% url 'channel' video.user.id %}" class="channel-name">{{ video.user.username }}</a>
                    <span class="channel-subscribers" id="subscriberCount">{{ subscriber_count }} subscribers</span>
                </div>
                {% if user.is_authenticated and user != video.user %}
                <button class="subscribe-btn {% if is_subscribed %}subscribed{% endif %}" id="subscribeBtn"
                    data-user-id="{{ video.user.id }}">
                    {% if is_subscribed %}Subscribed{% else %}Subscribe{% endif %}
                </button>
                {% endif %}
            </div>
            <div class="video-description">
                <p>{{ video.description|default:"No description available." }}</p>
            </div>
        </div>

        <!-- Comments Section -->
        <div class="comments-section">
            <h3>{{ comments.count }} Comments</h3>

            {% if user.is_authenticated %}
            <form class="comment-form" method="POST">
                {% csrf_token %}
                <div class="comment-avatar">{{ user.username|slice:":1"|upper }}</div>
                <div class="comment-input-wrapper">
                    {{ form.text }}
                    <button type="submit" class="btn btn-primary">Comment</button>
                </div>
            </form>
            {% else %}
            <p class="comment-login-prompt">
                <a href="{% url 'login' %}">Sign in</a> to add a comment
            </p>
            {% endif %}

            <div class="comments-list">
                {% for comment in comments %}
                <div class="comment">
                    <a href="{% url 'channel' comment.user.id %}" class="comment-avatar">
                        {{ comment.user.username|slice:":1"|upper }}
                    </a>
                    <div class="comment-content">
                        <div class="comment-header">
                            <a href="{% url 'channel' comment.user.id %}" class="comment-author">{{
                                comment.user.username }}</a>
                            <span class="comment-date">{{ comment.created_at|timesince }} ago</span>
                        </div>
                        <p class="comment-text">{{ comment.text }}</p>
                    </div>
                </div>
                {% empty %}
                <p class="no-comments">No comments yet. Be the first to comment!</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Related Videos -->
    <aside class="watch-sidebar">
        <h4>Up next</h4>
        {% for related in related_videos %}
        <div class="related-video">
            <a href="{% url 'video_detail' related.pk %}" class="related-thumbnail">
                {% if related.thumbnail %}
                <img src="{{ related.thumbnail.url }}" alt="{{ related.title }}">
                {% else %}
                <div class="thumbnail-placeholder-small">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path fill="currentColor" d="M8 5v14l11-7z" />
                    </svg>
                </div>
                {% endif %}
            </a>
            <div class="related-info">
                <a href="{% url 'video_detail' related.pk %}" class="related-title">{{ related.title }}</a>
                <a href="{% url 'channel' related.user.id %}" class="related-channel">{{ related.user.username }}</a>
                <div class="related-meta">{{ related.views }} views</div>
            </div>
        </div>
        {% empty %}
        <p>No related videos</p>
        {% endfor %}
    </aside>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const csrfToken = '{{ csrf_token }}';
    const videoId = {{ video.pk }};
    const channelId = {{ video.user.id }};
    const isAuthenticated = {{ user.is_authenticated| yesno: "true,false" }};
</script>
<script src="{% static 'core/js/video.js' %}"></script>
{% endblock %}